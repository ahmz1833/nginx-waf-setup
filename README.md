# Nginx WAF + Certbot + Monitoring Setup

A production-ready Dockerized setup for Nginx with OWASP ModSecurity Core Rule Set (WAF), automatic Let's Encrypt SSL (Certbot), structured logging, and Prometheus metrics.

## Features

- **WAF Protection**: OWASP ModSecurity CRS (Paranoia Level 1 by default).
- **SSL/TLS**:
  - Auto-renewal with Certbot (Let's Encrypt).
  - Hardened SSL config (HSTS, OCSP Stapling, modern ciphers).
  - Support for custom certificates.
- **Monitoring & Observability**:
  - JSON & Combined access logs.
  - Prometheus metrics exporter included.
  - Request ID correlation across logs and error pages.
- **Management**: Unified `manage.sh` script for site operations.
- **Custom Error Pages**: Modern, user-friendly error pages (400, 401, 403, 404, 429, 50x).

## Quick Start

1. **Start the stack:**

   ```bash
   docker-compose up -d
   ```

2. **Add a site:**

   ```bash
   ./manage.sh add example.com http://10.0.0.5:3000 auto
   ```

   *Modes: `http` (port 80), `auto` (Let's Encrypt), `custom` (provided certs).*

## Management Script (`manage.sh`)

The `manage.sh` script is your main interface.

| Command | Description |
|---------|-------------|
| `add <domain> <backend> <mode>` | Add/Update a site. Modes: `http`, `auto`, `custom`. |
| `remove <domain>` | Remove a site config and reload. |
| `list` | List configured sites. |
| `test-config` | Run `nginx -t` inside the container. |
| `reload` | Reload Nginx configuration. |
| `setup-cron` | Install a host cron job to reload Nginx daily (for cert renewals). |
| `enable-logging-snippet` | Print instructions to enable logging in main config. |

### Examples

**Add a site with Auto SSL:**

```bash
./manage.sh add myapp.com http://app_container:3000 auto
```

**Add a site with Custom SSL:**
Place `myapp.com.crt` and `myapp.com.key` in `certs/`, then:

```bash
./manage.sh add myapp.com http://10.10.10.5:8080 custom
```

**Remove a site:**

```bash
./manage.sh remove myapp.com
```

## Monitoring & Logging

### Logs

Logs are persisted to `./logs/nginx/`:

- `access.log`: Standard combined format.
- `access.json.log`: Structured JSON logs (ideal for Loki/ELK).
- `error.log`: Nginx error logs.

### Metrics

- **Nginx Stub Status**: `http://localhost:8080/stub_status` (internal/local access).
- **Prometheus Exporter**: `http://localhost:9113/metrics`.

## Configuration Structure

- `docker-compose.yml`: Service definitions (WAF, Certbot, Exporter).
- `sites/`: Per-domain Nginx configs (generated by `manage.sh`).
- `snippets/`: Reusable Nginx fragments.
  - `waf-general.conf`: WAF rules & error pages.
  - `ssl-params.conf`: Security headers & SSL tuning.
  - `logging.conf`: Log formats.
- `errors/`: HTML error page templates.
- `certs/`: Directory for custom SSL certificates.
- `letsencrypt/`: Directory for Let's Encrypt data.

## Security Notes

- **WAF Paranoia**: Default is Level 1. Adjust `PARANOIA` in `docker-compose.yml` if needed.
- **HSTS**: Enabled by default for 2 years in `ssl-params.conf`.
- **Request IDs**: Exposed via `X-Request-ID` header and on error pages for troubleshooting.
